---
title: "Plot_4PopSplit"
author: "Jennifer Blanc"
date: "1/21/2021"
output: html_document
---

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(knitr)
```

# Configuration 1

A/C are the GWAS panel  
B/D are the test panel  

Stratification in the GWAS pannel should effect PGS in the test population. Since there was an environmental effedt in A Population B should have greater PGS than D in the test panel. 

True Genetic Value (calculated using causal effect sizes)
```{r}
# Read in all Reps and Pick important columns 
agg_data <- function(rep, file_path, file_name) {
  gvalue <- fread(paste0(file_path, rep,file_name ))
  gwas.pop <- fread(paste0("../output/Simulate_Genotypes/4PopSplit/", rep, "/C1/ids.gwas"), header = F)
  colnames(gwas.pop) <- c("#IID", "FID", "POP")
  gvalue <- suppressMessages(full_join(gvalue,gwas.pop))
  gvalue$REP <- rep
  return(gvalue)
}

#reps <- list("B1", "B2", "B3", "B4", "B5", "B6", "B7", "B8", "B9", "B10", "B11", "B12", "B13", "B14", "B15", "B16", "B17", "B18", "B19", "B20" )
reps <- list("B1", "B2", "B3", "B4")
cols_gwas <- c("red2", "mediumblue")
df <- plyr::ldply(reps, agg_data, file_path='../output/Simulate_Phenotypes/4PopSplit/', file_name='/C1/h2-0/genos-gwas_common.gvalue.sscore')

# Histogram 
ggplot(data = df, aes(x= SCORE1_SUM, fill = POP)) + geom_histogram(data = subset(df, POP == "A"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(df, POP == "C"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("True PGS") + scale_fill_manual(values = cols_gwas)
```

Random Phenotypes (no stratification)
```{r}
df <- plyr::ldply(reps, agg_data, file_path='../output/Simulate_Phenotypes/4PopSplit/', file_name="/C1/h2-0/env-2/genos-gwas_common.phenos.txt")

# Histogram 
ggplot(data = df, aes(x=pheno_random, fill = POP)) + geom_histogram(data = subset(df, POP == "A"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(df, POP == "C"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("Random Phenotype") + scale_fill_manual(values = cols_gwas)
```

```{r}
t <- df %>% group_by(REP, POP) %>% 
        summarize(avg=mean(pheno_random))

diff <- 0
c <- seq(1,40,2)
for (i in c) {
  d <- t[i:(i+1), ]
  delta <- as.numeric(d[1,3]) - as.numeric(d[2,3])
  diff <- c(diff, delta)
}

diff <- diff[2:21]
table(diff > 0)
```


Phenotypes (stratification)
```{r}
# Histogram 
ggplot(data = df, aes(x=pheno_strat, fill = POP)) + geom_histogram(data = subset(df, POP == "A"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(df, POP == "C"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("Stratified Phenotype") + scale_fill_manual(values = cols_gwas)
```

```{r}
t <- df %>% group_by(REP, POP) %>% 
        summarize(avg=mean(pheno_strat))

diff <- 0
c <- seq(1,40,2)
for (i in c) {
  d <- t[i:(i+1), ]
  delta <- as.numeric(d[1,3]) - as.numeric(d[2,3])
  diff <- c(diff, delta)
}

diff <- diff[2:21]
table(diff > 0)
```

Random Phenotype - True Genetic Value  $E = Y - X\beta$  
```{r}
genos <- plyr::ldply(reps, agg_data, file_path='../output/Simulate_Phenotypes/4PopSplit/', file_name='/C1/h2-0/genos-gwas_common.gvalue.sscore')
phenos <- plyr::ldply(reps, agg_data, file_path='../output/Simulate_Phenotypes/4PopSplit/', file_name="/C1/h2-0/env-2/genos-gwas_common.phenos.txt")

E <- phenos$pheno_rand - genos$SCORE1_SUM 
df <- as.data.frame(cbind(genos$POP, genos$REP, E))
df$E <- as.numeric(levels(df$E))[df$E]

# Histogram 
ggplot(data = df, aes(x=E, fill =V1)) + geom_histogram(data = subset(df, V1 == "A"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(df, V1 == "C"), alpha = 0.75, bins = 30) + facet_wrap(~V2) + theme_bw() + xlab("Environment") + scale_fill_manual(values = cols_gwas)
```

Stratified Phenotype - True Genetic Value  $E = Y - X\beta$  (Pop A should have positive environment)
```{r}
genos <- plyr::ldply(reps, agg_data, file_path='../output/Simulate_Phenotypes/4PopSplit/', file_name='/C1/h2-0/genos-gwas_common.gvalue.sscore')
phenos <- plyr::ldply(reps, agg_data, file_path='../output/Simulate_Phenotypes/4PopSplit/', file_name="/C1/h2-0/env-2/genos-gwas_common.phenos.txt")

E <- phenos$pheno_strat - genos$SCORE1_SUM 
df <- as.data.frame(cbind(genos$POP, genos$REP, E))
df$E <- as.numeric(levels(df$E))[df$E]

# Histogram 
ggplot(data = df, aes(x=E, fill =V1)) + geom_histogram(data = subset(df, V1 == "A"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(df, V1 == "C"), alpha = 0.75, bins = 30) + facet_wrap(~V2) + theme_bw() + xlab("Environment") + scale_fill_manual(values = cols_gwas)
```

Polygenic Score in Test Population (clumping) - Random Phenotype
```{r}
agg_test <- function(rep, file_path, file_name_prs, file_name_gv) {
  
  prs <- fread(paste0(file_path, rep,file_name_prs))
  colnames(prs) <- c("#IID", "NAMED_ALLELE_DOSAGE_SUM", "RANDOM", "STRAT")
  
  gvalue <- fread(paste0(file_path, rep,file_name_gv))
  colnames(gvalue) <- c("#IID", "NAMED_ALLELE_DOSAGE_SUM", "GV")
  
  gwas.pop <- fread(paste0("../output/Simulate_Genotypes/4PopSplit/", rep, "/C1/ids.test"), header = F)
  colnames(gwas.pop) <- c("#IID", "FID", "POP")
  
  df <- suppressMessages(full_join(prs,gvalue, by ="#IID")) %>% select("#IID", "RANDOM", "STRAT", "GV")
  df <- suppressMessages(left_join(df, gwas.pop))
  df$REP <- rep
  
  mprs.adj = df%>%
  group_by(REP)%>%
    mutate(random.adjusted = RANDOM-GV,
           random.adjusted = (random.adjusted - mean(random.adjusted))/sd(random.adjusted),
           strat.adjusted = STRAT-GV,
           strat.adjusted = (strat.adjusted - mean(strat.adjusted))/sd(strat.adjusted)
           )%>%
    ungroup()
  
  return(mprs.adj)
}

prs <- plyr::ldply(reps, agg_test, file_path='../output/PRS/4PopSplit/', file_name_prs='/C1/h2-0/env-0/genos-test_common.c.sscore', file_name_gv='/C1/h2-0/genos-test_common.true.sscore')

cols_test <- c("darkgoldenrod1", "darkorchid1")

# Histogram 
ggplot(data = prs, aes(x=random.adjusted, fill = POP)) + geom_histogram(data = subset(prs, POP == "B"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(prs, POP == "D"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("PRS Random") + scale_fill_manual(values = cols_test)
```

```{r}
# Histogram 
ggplot(data = prs, aes(x=GV, fill = POP)) + geom_histogram(data = subset(prs, POP == "B"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(prs, POP == "D"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("PRS Random") + scale_fill_manual(values = cols_test)
```


Polygenic Score in Test Population - Stratified Phenotype
```{r}
# Histogram 
ggplot(data = prs, aes(x=strat.adjusted, fill = POP)) + geom_histogram(data = subset(prs, POP == "B"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(prs, POP == "D"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("PRS Stratification") + scale_fill_manual(values = cols_test)
```

Mean Difference Across Populations
```{r}
mprs.sum = prs%>%
  group_by(POP)%>%
  summarize(mean.prs.random = mean(random.adjusted), mean.prs.strat = mean(strat.adjusted) )%>%
  ungroup()

kable(mprs.sum)
```

Covariance between Test Vector and PGS
```{r}
agg_Tvecs <- function(rep, file_path, file_name) {
  Tvec <- fread(paste0(file_path, rep,file_name ))
  std.tvec <- Tvec$V1
  return(std.tvec)
}

test_vecs <- plyr::ldply(reps, agg_Tvecs, file_path='../output/Calculate_Tm/4PopSplit/', file_name='/C1/Tvec.txt')

cov_strat_C1 <- rep(0, length(reps))
cov_random_C1 <- rep(0, length(reps))
for (i in 1:length(cov_strat_C1)) {
  p <- subset(prs, prs$REP == reps[[i]])
  cov_strat_C1[i] <- cov(p$strat.adjusted, t(test_vecs[i,]))
  cov_random_C1[i] <- cov(p$random.adjusted, t(test_vecs[i,]))
}

mean(cov_strat_C1)
mean(cov_random_C1)

mod <- lm(t(test_vecs[1,]) ~ subset(prs, prs$REP == "B1")$random.adjusted)
summary(mod)
```

Polygenic Score in Test Population (clumping) - Random Phenotype including Tm as a Covariate
```{r}
agg_test <- function(rep, file_path, file_name_prs, file_name_gv) {
  
  prs <- fread(paste0(file_path, rep,file_name_prs))
  colnames(prs) <- c("#IID", "NAMED_ALLELE_DOSAGE_SUM", "RANDOM", "STRAT")
  
  gvalue <- fread(paste0(file_path, rep,file_name_gv))
  colnames(gvalue) <- c("#IID", "NAMED_ALLELE_DOSAGE_SUM", "GV")
  
  gwas.pop <- fread(paste0("../output/Simulate_Genotypes/4PopSplit/", rep, "/C1/ids.test"), header = F)
  colnames(gwas.pop) <- c("#IID", "FID", "POP")
  
  df <- suppressMessages(full_join(prs,gvalue, by ="#IID")) %>% select("#IID", "RANDOM", "STRAT", "GV")
  df <- suppressMessages(left_join(df, gwas.pop))
  df$REP <- rep
  
  mprs.adj = df%>%
  group_by(REP)%>%
    mutate(random.adjusted = RANDOM-GV,
           random.adjusted = (random.adjusted - mean(random.adjusted))/sd(random.adjusted),
           strat.adjusted = STRAT-GV,
           strat.adjusted = (strat.adjusted - mean(strat.adjusted))/sd(strat.adjusted)
           )%>%
    ungroup()
  
  return(mprs.adj)
}

prs <- plyr::ldply(reps, agg_test, file_path='../output/PRS/4PopSplit/', file_name_prs='/C1/h2-0/env-0/genos-test_common-Tm.nc.sscore', file_name_gv='/C1/genos-test_common.true.sscore')

cols_test <- c("darkgoldenrod1", "darkorchid1")

# Histogram 
ggplot(data = prs, aes(x=random.adjusted, fill = POP)) + geom_histogram(data = subset(prs, POP == "B"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(prs, POP == "D"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("PRS Random") + scale_fill_manual(values = cols_test)
```

Polygenic Score in Test Population - Stratified Phenotype inlcuding Tm as a covariate
```{r}
# Histogram 
ggplot(data = prs, aes(x=strat.adjusted, fill = POP)) + geom_histogram(data = subset(prs, POP == "B"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(prs, POP == "D"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("PRS Stratification") + scale_fill_manual(values = cols_test)
```

Mean Difference Across Populations
```{r}
mprs.sum = prs%>%
  group_by(POP)%>%
  summarize(mean.prs.random = mean(random.adjusted), mean.prs.strat = mean(strat.adjusted) )%>%
  ungroup()

kable(mprs.sum)
```

Covariance between Test Vector and PGS - including Tm as a covariate
```{r}
agg_Tvecs <- function(rep, file_path, file_name) {
  Tvec <- fread(paste0(file_path, rep,file_name ))
  std.tvec <- Tvec$V1
  return(std.tvec)
}

test_vecs <- plyr::ldply(reps, agg_Tvecs, file_path='../output/Calculate_Tm/4PopSplit/', file_name='/C1/Tvec.txt')

cov_strat_C1_Tm <- rep(0, length(reps))
cov_random_C1_Tm <- rep(0, length(reps))
for (i in 1:length(cov_strat_C1_Tm)) {
  p <- subset(prs, prs$REP == reps[[i]])
  cov_strat_C1_Tm[i] <- cov(p$strat.adjusted, t(test_vecs[i,]))
  cov_random_C1_Tm[i] <- cov(p$random.adjusted, t(test_vecs[i,]))
}

mean(cov_strat_C1_Tm)
mean(cov_random_C1_Tm)
```

# Configuration 2

A/B are the GWAS panel  
C/D are the test panel  

True Genetic Value (calculated using causal effect sizes)
```{r}
# Read in all Reps and Pick important columns 
agg_data <- function(rep, file_path, file_name) {
  gvalue <- fread(paste0(file_path, rep,file_name ))
  gwas.pop <- fread(paste0("../output/Simulate_Genotypes/4PopSplit/", rep, "/C2/ids.gwas"), header = F)
  colnames(gwas.pop) <- c("#IID", "FID", "POP")
  gvalue <- suppressMessages(full_join(gvalue,gwas.pop))
  gvalue$REP <- rep
  return(gvalue)
}
cols_gwas <- c("red2", "mediumblue")
df <- plyr::ldply(reps, agg_data, file_path='../output/Simulate_Phenotypes/4PopSplit/', file_name='/C2/genos-gwas_common.gvalue.sscore')

# Histogram 
ggplot(data = df, aes(x= SCORE1_SUM, fill = POP)) + geom_histogram(data = subset(df, POP == "A"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(df, POP == "B"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("True PGS") + scale_fill_manual(values = cols_gwas)
```

Random Phenotypes (no stratification)
```{r}
df <- plyr::ldply(reps, agg_data, file_path='../output/Simulate_Phenotypes/4PopSplit/', file_name="/C2/genos-gwas_common.phenos.txt")

# Histogram 
ggplot(data = df, aes(x=pheno_random, fill = POP)) + geom_histogram(data = subset(df, POP == "A"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(df, POP == "B"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("Random Phenotype") + scale_fill_manual(values = cols_gwas)
```

Phenotypes (stratification)
```{r}
# Histogram 
ggplot(data = df, aes(x=pheno_strat, fill = POP)) + geom_histogram(data = subset(df, POP == "A"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(df, POP == "B"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("Stratified Phenotype") + scale_fill_manual(values = cols_gwas)
```

Stratified Phenotype - True Genetic Value (Pop A should have positive environment)
```{r}
genos <- plyr::ldply(reps, agg_data, file_path='../output/Simulate_Phenotypes/4PopSplit/', file_name='/C2/genos-gwas_common.gvalue.sscore')
phenos <- plyr::ldply(reps, agg_data, file_path='../output/Simulate_Phenotypes/4PopSplit/', file_name="/C2/genos-gwas_common.phenos.txt")

E <- phenos$pheno_strat - genos$SCORE1_SUM 
df <- as.data.frame(cbind(genos$POP, genos$REP, E))
df$E <- as.numeric(levels(df$E))[df$E]

# Histogram 
ggplot(data = df, aes(x=E, fill =V1)) + geom_histogram(data = subset(df, V1 == "A"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(df, V1 == "B"), alpha = 0.75, bins = 30) + facet_wrap(~V2) + theme_bw() + xlab("Environment") + scale_fill_manual(values = cols_gwas)
```

Polygenic Score in Test Population - Random Phenotype
```{r}
agg_test <- function(rep, file_path, file_name_prs, file_name_gv) {
  
  prs <- fread(paste0(file_path, rep,file_name_prs))
  colnames(prs) <- c("#IID", "NAMED_ALLELE_DOSAGE_SUM", "RANDOM", "STRAT")
  
  gvalue <- fread(paste0(file_path, rep,file_name_gv))
  colnames(gvalue) <- c("#IID", "NAMED_ALLELE_DOSAGE_SUM", "GV")
  
  gwas.pop <- fread(paste0("../output/Simulate_Genotypes/4PopSplit/", rep, "/C2/ids.test"), header = F)
  colnames(gwas.pop) <- c("#IID", "FID", "POP")
  
  df <- suppressMessages(full_join(prs,gvalue, by ="#IID")) %>% select("#IID", "RANDOM", "STRAT", "GV")
  df <- suppressMessages(left_join(df, gwas.pop))
  df$REP <- rep
  
  mprs.adj = df%>%
  group_by(REP)%>%
    mutate(random.adjusted = RANDOM-GV,
           random.adjusted = (random.adjusted - mean(random.adjusted))/sd(random.adjusted),
           strat.adjusted = STRAT-GV,
           strat.adjusted = (strat.adjusted - mean(strat.adjusted))/sd(strat.adjusted)
           )%>%
    ungroup()
  
  return(mprs.adj)
}


prs <- plyr::ldply(reps, agg_test, file_path='../output/PRS/4PopSplit/', file_name_prs='/C2/genos-test_common.nc.sscore', file_name_gv='/C2/genos-test_common.true.sscore')
cols_test <- c("darkgoldenrod1", "darkorchid1")

# Histogram 
ggplot(data = prs, aes(x=RANDOM, fill = POP)) + geom_histogram(data = subset(prs, POP == "C"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(prs, POP == "D"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("PRS Random") + scale_fill_manual(values = cols_test)
```

Polygenic Score in Test Population - Stratified Phenotype
```{r}
# Histogram 
ggplot(data = prs, aes(x=STRAT, fill = POP)) + geom_histogram(data = subset(prs, POP == "C"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(prs, POP == "D"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("PRS Strat") + scale_fill_manual(values = cols_test)
```

Mean Difference Across Populations
```{r}
mprs.sum = prs%>%
  group_by(POP)%>%
  summarize(mean.prs.random = mean(random.adjusted), mean.prs.strat = mean(strat.adjusted) )%>%
  ungroup()

kable(mprs.sum)
```

Covariance between Test Vector and PGS 
```{r}
agg_Tvecs <- function(rep, file_path, file_name) {
  Tvec <- fread(paste0(file_path, rep,file_name ))
  std.tvec <- Tvec$V1
  return(std.tvec)
}

test_vecs <- plyr::ldply(reps, agg_Tvecs, file_path='../output/Calculate_Tm/4PopSplit/', file_name='/C1/Tvec.txt')

cov_strat_C2 <- rep(0, length(reps))
cov_random_C2 <- rep(0, length(reps))
for (i in 1:length(cov_strat_C2)) {
  p <- subset(prs, prs$REP == reps[[i]])
  cov_strat_C2[i] <- cov(p$strat.adjusted, t(test_vecs[i,]))
  cov_random_C2[i] <- cov(p$random.adjusted, t(test_vecs[i,]))
}

mean(cov_strat_C2)
mean(cov_random_C2)
```

Polygenic Score in Test Population - Random Phenotype - includin Tm as a covariate
```{r}
agg_test <- function(rep, file_path, file_name_prs, file_name_gv) {
  
  prs <- fread(paste0(file_path, rep,file_name_prs))
  colnames(prs) <- c("#IID", "NAMED_ALLELE_DOSAGE_SUM", "RANDOM", "STRAT")
  
  gvalue <- fread(paste0(file_path, rep,file_name_gv))
  colnames(gvalue) <- c("#IID", "NAMED_ALLELE_DOSAGE_SUM", "GV")
  
  gwas.pop <- fread(paste0("../output/Simulate_Genotypes/4PopSplit/", rep, "/C2/ids.test"), header = F)
  colnames(gwas.pop) <- c("#IID", "FID", "POP")
  
  df <- suppressMessages(full_join(prs,gvalue, by ="#IID")) %>% select("#IID", "RANDOM", "STRAT", "GV")
  df <- suppressMessages(left_join(df, gwas.pop))
  df$REP <- rep
  
  mprs.adj = df%>%
  group_by(REP)%>%
    mutate(random.adjusted = RANDOM-GV,
           random.adjusted = (random.adjusted - mean(random.adjusted))/sd(random.adjusted),
           strat.adjusted = STRAT-GV,
           strat.adjusted = (strat.adjusted - mean(strat.adjusted))/sd(strat.adjusted)
           )%>%
    ungroup()
  
  return(mprs.adj)
}


prs <- plyr::ldply(reps, agg_test, file_path='../output/PRS/4PopSplit/', file_name_prs='/C2/genos-test_common-Tm.nc.sscore', file_name_gv='/C2/genos-test_common.true.sscore')
cols_test <- c("darkgoldenrod1", "darkorchid1")

# Histogram 
ggplot(data = prs, aes(x=RANDOM, fill = POP)) + geom_histogram(data = subset(prs, POP == "C"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(prs, POP == "D"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("PRS Random") + scale_fill_manual(values = cols_test)
```

Polygenic Score in Test Population - Stratified Phenotype -inluding Tm as a covariate
```{r}
# Histogram 
ggplot(data = prs, aes(x=STRAT, fill = POP)) + geom_histogram(data = subset(prs, POP == "C"), alpha = 0.75, bins = 30) + geom_histogram(data = subset(prs, POP == "D"), alpha = 0.75, bins = 30) + facet_wrap(~REP) + theme_bw() + xlab("PRS Strat") + scale_fill_manual(values = cols_test)
```

Mean Difference Across Populations
```{r}
mprs.sum = prs%>%
  group_by(POP)%>%
  summarize(mean.prs.random = mean(random.adjusted), mean.prs.strat = mean(strat.adjusted) )%>%
  ungroup()

kable(mprs.sum)
```

Covariance between Test Vector and PGS - including Tm as a covariate
```{r}
agg_Tvecs <- function(rep, file_path, file_name) {
  Tvec <- fread(paste0(file_path, rep,file_name ))
  std.tvec <- Tvec$V1
  return(std.tvec)
}

test_vecs <- plyr::ldply(reps, agg_Tvecs, file_path='../output/Calculate_Tm/4PopSplit/', file_name='/C1/Tvec.txt')

cov_strat_C2_Tm <- rep(0, length(reps))
cov_random_C2_Tm <- rep(0, length(reps))
for (i in 1:length(cov_strat_C2_Tm)) {
  p <- subset(prs, prs$REP == reps[[i]])
  cov_strat_C2_Tm[i] <- cov(p$strat.adjusted, t(test_vecs[i,]))
  cov_random_C2_Tm[i] <- cov(p$random.adjusted, t(test_vecs[i,]))
}

mean(cov_strat_C2_Tm,)
mean(cov_random_C2_Tm)
```

## Summary 

Write function to gather all datasets and plot in one plot  

```{r}
reps <- list("B1", "B2", "B3", "B4", "B5", "B6", "B7", "B8", "B9", "B10", "B11", "B12", "B13", "B14", "B15", "B16", "B17", "B18", "B19", "B20" )
agg_all_data <- function(rep, dir_path, case, type) {
  
  prs <- fread(paste0(dir_path, rep,"/", case, "/", 'genos-test_common', type))
  colnames(prs) <- c("#IID", "NAMED_ALLELE_DOSAGE_SUM", "RANDOM", "STRAT")
  
  gvalue <- fread(paste0(dir_path, rep,"/", case, "/" , 'genos-test_common.true.sscore'))
  colnames(gvalue) <- c("#IID", "NAMED_ALLELE_DOSAGE_SUM", "GV")
  
  gwas.pop <- fread(paste0("../output/Simulate_Genotypes/4PopSplit/", rep, "/", case, "/" , "ids.test"), header = F)
  colnames(gwas.pop) <- c("#IID", "FID", "POP")
  
  df <- suppressMessages(full_join(prs,gvalue, by ="#IID")) %>% select("#IID", "RANDOM", "STRAT", "GV")
  df <- suppressMessages(left_join(df, gwas.pop))
  df$REP <- rep
  
  mprs.adj = df%>%
  group_by(REP)%>%
    mutate(random.adjusted = RANDOM-GV,
           random.adjusted = (random.adjusted - mean(random.adjusted))/sd(random.adjusted),
           strat.adjusted = STRAT-GV,
           strat.adjusted = (strat.adjusted - mean(strat.adjusted))/sd(strat.adjusted)
           )%>%
    ungroup() %>% select(POP, REP, random.adjusted, strat.adjusted)
  colnames(mprs.adj) <-c("POP", "REP", "RANDOM", "STRAT")
  
  mprs.adj$TYPE <- paste0(case, type)
  
  return(mprs.adj)
}

concat_prs <- function(type_prs, cases) {
  prs <- plyr::ldply(reps, agg_all_data, dir_path='../output/PRS/4PopSplit/',case = cases, type=type_prs)
  return(prs)
}

all_prs_types <- c(".c.sscore", ".c.p.sscore", ".nc.sscore", "-Tm.c.p.sscore", "-Tm.c.sscore", "-Tm.nc.sscore")
cases <- c("C1", "C2")

dat <- expand.grid(all_prs_types, cases)
colnames(dat) <- c("type_prs", "cases")
df <- plyr::mdply(dat, concat_prs)
```

```{r}
plot_df_random <- df %>% group_by(POP, TYPE) %>% summarise(MEAN = mean(RANDOM)) %>% select(POP, TYPE, MEAN)
plot_df_random$PHENO <- "Random"
```


```{r}
plot_df_strat <- df %>% group_by(POP, TYPE) %>% summarise(MEAN = mean(STRAT)) %>% select(POP, TYPE, MEAN)
plot_df_strat$PHENO <- "Strat"
```


```{r}
cc_df <- rbind(plot_df_random, plot_df_strat)

ggplot(cc_df, aes(x = POP, y = TYPE)) + geom_tile(aes(fill = MEAN)) + facet_wrap(~PHENO) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank()) + xlab("Test Population Label") + scale_fill_gradient2(low = "#91bfdb", mid = "#ffffbf",high = "#fc8d59", limits = c(-0.65, 0.65), breaks = c(-0.6, -0.3, 0, 0.3, 0.6), name = "Mean PRS")
```


```{r}
agg_all_cov <- function(rep, dir_path, case, type) {
  #print(paste0(rep, case, type))
  
  prs <- fread(paste0(dir_path, rep,"/", case, "/", 'genos-test_common', type))
  colnames(prs) <- c("#IID", "NAMED_ALLELE_DOSAGE_SUM", "RANDOM", "STRAT")
  
  gvalue <- fread(paste0(dir_path, rep,"/", case, "/" , 'genos-test_common.true.sscore'))
  colnames(gvalue) <- c("#IID", "NAMED_ALLELE_DOSAGE_SUM", "GV")
  
  gwas.pop <- fread(paste0("../output/Simulate_Genotypes/4PopSplit/", rep, "/", case, "/" , "ids.test"), header = F)
  colnames(gwas.pop) <- c("#IID", "FID", "POP")
  
  df <- suppressMessages(full_join(prs,gvalue, by ="#IID")) %>% select("#IID", "RANDOM", "STRAT", "GV")
  df <- suppressMessages(left_join(df, gwas.pop))
  df$REP <- rep
  
  mprs.adj = df%>%
  group_by(REP)%>%
    mutate(random.adjusted = RANDOM-GV,
           random.adjusted = (random.adjusted - mean(random.adjusted))/sd(random.adjusted),
           strat.adjusted = STRAT-GV,
           strat.adjusted = (strat.adjusted - mean(strat.adjusted))/sd(strat.adjusted)
           )%>%
    ungroup() 
  
  Tvec <- fread(paste0("../output/Calculate_Tm/4PopSplit/", rep, "/", case, "/", "Tvec.txt"))
  std.tvec <- Tvec$V1
  
  mprs.sum = mprs.adj %>% 
    summarise(COV_STRAT = cov(std.tvec, strat.adjusted), COV_RANDOM = cov(std.tvec, random.adjusted))
  
  #std.tvec[std.tvec < 0] <- 0
  #std.tvec[std.tvec > 0] <- 1
  #mod <- logistf(as.factor(std.tvec) ~ mprs.adj$strat.adjusted)
  #mprs.sum$p_strat <- summary(mod)$coefficients[2,4]
  
  B <- subset(mprs.adj, mprs.adj$POP == mprs.adj$POP[1])
  B <- B$STRAT
  D <- subset(mprs.adj, mprs.adj$POP == "D")
  D <- D$STRAT
  t.out <- t.test(B,D)
  mprs.sum$p_strat <- t.out$p.value
  
  #mod <- glm(std.tvec ~ mprs.adj$random.adjusted, family = "binomial")
  #mprs.sum$p_random <- summary(mod)$coefficients[2,4] 
  
  B <- subset(mprs.adj, mprs.adj$POP == mprs.adj$POP[1])
  B <- B$RANDOM
  D <- subset(mprs.adj, mprs.adj$POP == "D")
  D <- D$RANDOM
  t.out <- t.test(B,D)
  mprs.sum$p_random <- t.out$p.value
  
  mprs.sum$TYPE <- paste0(case, type)
  mprs.sum$REP <- rep
  
  return(mprs.sum)
}

concat_prs <- function(type_prs, cases) {
  prs <- plyr::ldply(reps, agg_all_cov, dir_path='../output/PRS/4PopSplit/',case = cases, type=type_prs)
  return(prs)
}

all_prs_types <- c(".c.sscore", ".c.p.sscore", ".nc.sscore", "-Tm.c.p.sscore", "-Tm.c.sscore", "-Tm.nc.sscore")
cases <- c("C1", "C2")

dat <- expand.grid(all_prs_types, cases)
colnames(dat) <- c("type_prs", "cases")
df_sum <- plyr::mdply(dat, concat_prs)
```

```{r}
plot_cov <- df_sum %>% group_by(TYPE) %>% summarise(STRAT = mean(COV_STRAT), RANDOM = mean(COV_RANDOM)) %>% gather(PHENO, PRS, -TYPE)

ggplot(plot_cov, aes(x = PHENO, y = TYPE)) + geom_tile(aes(fill = PRS)) + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.title.y = element_blank()) + xlab("") + scale_fill_gradient2(low = "#91bfdb", mid = "#ffffbf",high = "#fc8d59", limits = c(-0.35, 0.65), breaks = c(-0.6, -0.3, 0, 0.3, 0.6), name = "Avg Cov.")
```

```{r}
c_file = "output/PRS/4PopSplit/B3/C2/h2-0/env-2/genos-test_common.c.sscore"
cp_file = "output/PRS/4PopSplit/B3/C2/h2-0/env-2/genos-test_common.c.p.sscore"
nc_file = "output/PRS/4PopSplit/B3/C2/h2-0/env-2/genos-test_common.nc.sscore"
nc_Tm_file = "output/PRS/4PopSplit/B3/C2/h2-0/env-2/genos-test_common-Tm.nc.sscore"
c_Tm_file = "output/PRS/4PopSplit/B3/C2/h2-0/env-2/genos-test_common-Tm.c.sscore"
cp_Tm_file = "output/PRS/4PopSplit/B3/C2/h2-0/env-2/genos-test_common-Tm.c.p.sscore"
lambda_T_file = "output/Calculate_Tm/4PopSplit/B3/C2/Lambda_T.txt"
Va_file = "output/PGA_test/4PopSplit/B3/C2/h2-0/env-2/Va.txt"
Va_Tm_file = "output/PGA_test/4PopSplit/B3/C2/h2-0/env-2/Va-Tm.txt"
true_file="output/PRS/4PopSplit/B3/C2/h2-0/genos-test_common.true.sscore"
out_file = "output/Calculate_Tm/4PopSplit/B3/C2/Tvec.txt"
tvec_file = "output/Calculate_Tm/4PopSplit/B3/C2/Tvec.txt"
```

