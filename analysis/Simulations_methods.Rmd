---
title: "Simulations_Methods"
author: "Jennifer Blanc"
date: "7/23/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(latex2exp)
```

## Introduction 

Here I will reccord the details for the simulations presented in the main text and the supplement. I will also include the code to make the the figures. The illustrative examples for the 3 simulation types can be found **here** (link later).  

## 4PopSplit 

### Msprime simulation 

Generate diplois individuals according to the demographic model below 

* T2 = 11000  
* T1 (deeper split) = 22000 
* Ne (ancestral = A = B = C = D)  = 10000
* sample size = 1000 diploids per population  
* chromosome length = 100000  
* 200 chromosomes  
* $\mu$ = 1e-08  
* $\rho$ = 1e-08  

The simulation was run 100 times total. 

### Create genotypes panels and filter SNPs

1. Set up 2 parallel sets of 2  
  1. C1: GWAS panel has the 1000 individuals from populations A and C (2000 total), test panel has the 1000 inidividuals from B and D (2000 total)
  2. C2: GWAS panel has the 1000 individuals from populations A and B (2000 total), test panel has the 1000 inidividuals from C and D (2000 total)
2. Filter snps to sites segregating at greater than 5% frequency within each panel  

### Draw phenotype 

Notes:  

* All simulations have $h^2 = 0$  

1. Sample random phenotype $N(0,1)$ for all GWAS indviduals 
2. Mean center the phenotype within each 
3. For all individuals in population A shift the mean phenotype by a variable amount 

### Project Test Vector  

1. Set test vector as a standardized, mean-centered $n \times 1$ vector with each entry as the test panel individuals population ID (1 vs 0) encoding   
2. Project test vector in GWAS panel, resulting in an $m \times 1$ (see ___ for more detail)

### Run GWASs  

1. Use plink to run GWAS with and without including projected test vector 

### Calculate PGS and Qx 

1. Pick the SNP with lowest p-value per chromosome to include in PGS (200 SNPs total)  
2. Compute PGS in test panel individuals 
3. Calculate $V_a$ 
4. Calculate the amount of variance explained by the test vector ($\lambda_T$; note that we used a test vector with $1/2*n_{pop}$,$ -1/2 *n_{pop}$ encoding)  
5. Calculate empirical null p-value by permuting the signs of the SNP effect sizes 1,000 times and computing the proportion of permutations greater than the true $Q_x$ value.  

### Figures  

```{r, warning=FALSE, message=FALSE, echo=FALSE}
df <- fread("../code/plot/T100.txt")
nc <- df %>% filter(type == "nc"| type == "nc-Tm") %>% filter(case == "C1")  %>% group_by(env, type, case) %>% summarise(fp_strat = sum(`P-EN` < 0.05)/ n(), avg_Ax = mean(Ax)) %>% separate(env, c("env", "diff"), "-")
nc$diff <- as.numeric(nc$diff)

nc <- subset(nc, nc$diff < 0.07)
ggplot(data = nc, aes(x = diff, y = fp_strat, color = type)) + geom_point(size =3)+ xlab("Mean(A) - Mean(C)") + ylab("False Postive Rate") + theme_classic(base_size = 14) + scale_color_manual(values = c("goldenrod2", "navy"), labels = unname(TeX(c("No covariate", " Including $T^{GWAS}")))) + theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) + ylim(0,1) + labs(colour="GWAS") + theme(legend.text.align = 0)+ geom_hline(yintercept = 0.05, color = "red") + geom_smooth(method = "loess", se = FALSE) 
```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
df <- fread("../code/plot/4PopSplit_F100_rescale.txt")
nc <- df %>% filter(type == "nc"| type == "nc-Tm") %>% filter(case == "C1")  %>% group_by(env, type, case) %>% summarise(fp_strat = sum(`P-EN` < 0.05)/ n(), avg_Ax = mean(Ax)) %>% separate(env, c("env", "diff"), "-")
nc$diff <- as.numeric(nc$diff)

nc <- subset(nc, nc$diff < 0.07)
ggplot(data = nc, aes(x = diff, y = fp_strat, color = type)) + geom_point(size =3)+ xlab("Mean(A) - Mean(C)") + ylab("False Postive Rate") + theme_classic(base_size = 14) + scale_color_manual(values = c("goldenrod2", "navy"), labels = unname(TeX(c("No covariate", " Including $T^{GWAS}")))) + theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) + ylim(0,1) + labs(colour="GWAS") + theme(legend.text.align = 0)+ geom_hline(yintercept = 0.05, color = "red") + geom_smooth(method = "loess", se = FALSE) 
```

## Simple Grid 

### Msprime simulation 

Generate diploid individuals using a stepping stone model on a 6x6 grid with the parameters below: 

Parameters: 

* 200 chromosomes  
* sample size = 80 diploids  
* Ne = 1000 
* $\mu$ = 1e-07  
* $\rho$ = 1e-07 
* m = 0.01  
* chromosome length = 100000 
* tmove = -9 (perpetual structure)  


The simulation was run 100 times total.  

### Create genotypes panels and filter SNPs

1. Sample 20 individuals per deme for test panels (36 * 20 individuals total) 
2. Remaining individuals (60 per deme) become the GWAS panel  
3. Restrict snps to sites segregating at greater than 5% frequency within each panel  

### Draw phenotype 

Notes:  

* All simulations have $h^2 = 0$  
* ENV is the magnitude of the phenotype shift 

1. Sample random phenotype $N(0,1)$ for all GWAS indviduals 
2. For all individuals within a given latitude add (Latitude * (ENV / 5)) to their phenotype values

### Project Test Vector  

1. Set test vector as a mean centered $n \times 1$ vector with each entry as the test panel individuals latitude  
2. Project test vector in GWAS panel, resulting in an $m \times 1$ (see ___ for more detail)

### Run GWASs  

1. Use plink to run GWAS with and without including projected test vector 

### Calculate PGS and Qx 

1. Pick the SNP with lowest p-value per chromosome to include in PGS (200 SNPs total)  
2. Compute PGS in test panel individuals 
3. Calculate $V_a$ 
4. Calculate the amount of variance explained by the test vector ($\lambda_T$; note that we used the mean-centered test vector to compute this)  
5. Calculate empirical null p-value by permuting the signs of the SNP effect sizes 1,000 times and computing the proportion of permutations greater than the true $Q_x$ value.  

### Figures  

```{r, warning=FALSE, message=FALSE, echo=FALSE}
df <- fread("../code/plot/Simple_Grid_T100.txt")
nc <- df %>% filter(type == "nc"| type == "nc-Tm") %>% filter(case == "C1")  %>% group_by(env, type, case) %>% summarise(fp_strat = sum(`P-EN` < 0.05)/ n(), avg_Ax = mean(Ax)) %>% separate(env, c("env", "diff"), "-")
nc$diff <- as.numeric(nc$diff)
nc <- subset(nc, nc$diff < 0.1)


ggplot(data = nc, aes(x = diff, y = fp_strat, color = type)) + geom_point(size =3)+ xlab("Env") + ylab("False Postive Rate") + theme_classic(base_size = 14) + scale_color_manual(values = c("goldenrod2", "navy"), labels = unname(TeX(c("No covariate", " Including $T^{GWAS}")))) + theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) + ylim(0,1) + labs(colour="GWAS") + theme(legend.text.align = 0)+ geom_hline(yintercept = 0.05, color = "red") + scale_x_continuous(breaks = c(0, 0.03, 0.06, 0.09))+ geom_smooth(method = "loess", se = FALSE) 
```


## Conference figures 

```{r}
A <- rnorm(10000, 0, 1)
C <- rnorm(10000, 3, 1)

df <- cbind(A,C)
df <- melt(df)
ggplot(df, aes(x = value, fill = Var2)) + geom_density(alpha=0.5) + theme_classic(base_size = 14) + xlab("Phenotype")+ ylab("") + scale_fill_manual(values = c("darkred", "goldenrod")) + theme(axis.ticks = element_blank(), axis.text = element_blank(), axis.line.y=element_blank(), , axis.title.x = element_text(size = 20)) + geom_vline(xintercept = 0, color = "darkred", size = 1.5)+ geom_vline(xintercept = 3, color = "goldenrod", size = 1.5)  + scale_y_continuous(expand = c(0, 0))
```

```{r}
D <- rnorm(1000, 3, 1)
C <- rnorm(1000, 0, 1)

df <- cbind(C,D)
df <- melt(df)
ggplot(df, aes(x = value, fill = Var2)) + geom_density(alpha=0.5) + theme_classic(base_size = 14) + xlab("Polygenic Score")+ ylab("") + scale_fill_manual(values = c("darkblue","forestgreen")) + theme(axis.ticks = element_blank(), axis.text = element_blank(), axis.line.y=element_blank(), axis.title.x = element_text(size = 20)) + geom_vline(xintercept = 0, color = "darkblue", size = 1.5)+ geom_vline(xintercept = 0, color = "forestgreen", size = 1.5)  + scale_y_continuous(expand = c(0, 0))

ggplot(df, aes(x =Var2,y=value, color = Var2)) + geom_jitter() + theme_classic(base_size = 16) + scale_color_manual(values = c("darkblue","forestgreen")) + xlab("Population") + ylab("Polygenic Score") + stat_summary(fun.y=mean, colour="black", geom="line", aes(group = 1), size = 3) + stat_summary(fun.y=mean, colour="black", geom="point", aes(group = 1), size = 3)
```

```{r}
Latitude <- seq(0, 100, 1)
PGS <- Latitude + rnorm(length(Latitude), 0, 10)

df <- as.data.frame(cbind(PGS, Latitude))
ggplot(df, aes(x = Latitude, y = PGS)) + geom_point(size = 2, color = "darkmagenta") + theme_classic(base_size = 16) +geom_smooth(method='lm', se = FALSE, color = "black", linetype = "dashed") + ylab("Polygenic Score") + theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.title.x = element_text(size = 22))
```

```{r}
Temperature <- rep(0, 100)
PGS <- Temperature + rnorm(length(Temperature), 0, 5)

df <- as.data.frame(cbind(PGS, seq(37, 46.9, 0.1)))
ggplot(df, aes(x = V2, y = PGS)) + geom_point(size = 2, color = "deeppink3") + theme_classic(base_size = 16) +geom_smooth(method='lm', se = FALSE, color = "black", linetype = "dashed") + ylab("Polygenic Score") + xlab("Temperature") +theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.title.x = element_text(size = 22))
```

```{r}
Time <-  seq(0, 10000, 100)
PGS <- Time + rnorm(length(Time), 0, 1000)

df <- as.data.frame(cbind(PGS, Time))
ggplot(df, aes(x = -1*Time, y = PGS)) + geom_point(size = 2, color = "slateblue4") + theme_classic(base_size = 16) +geom_smooth(method='lm', se = FALSE, color = "black", linetype = "dashed") + ylab("Polygenic Score") + xlab("Time") +theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.title.x = element_text(size = 22))
```

```{r}
pop <-  rep(seq(1,8, 1),10)
PGS <- pop + rnorm(length(pop), 0, 1)

df <- as.data.frame(cbind(PGS, pop))
ggplot(df, aes(x = pop, y = PGS, color = pop)) + geom_point(size = 2) + theme_classic(base_size = 16) +geom_smooth(method='lm', se = FALSE, color = "black", linetype = "dashed") + ylab("Polygenic Score") + xlab("Population ID") +theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), axis.title.x = element_text(size = 22))
```


```{r}
df <- fread("~/polygenic_adaptation_stratification/code/plot/SimpleGrid_C1_scale_T100_pgs.txt")

df2 <- df %>% filter(env == "env-0.05") %>% group_by(rep, case, env) %>% mutate(nc_stan = (nc - mean(nc)) / sd(nc), nc_Tm_stan = (nc_Tm - mean(nc_Tm)) / sd(nc_Tm)) %>% ungroup() %>% group_by(POP, env) %>% summarise(avg_PRS = mean(nc_stan), avg_PRS_Tm = mean(nc_Tm_stan),LAT = mean(LAT), LONG = mean(LONG))
df3 <- df2[,3:6] %>%  gather(variable, value, -c(LAT, LONG))

df3$variable <- factor(df3$variable ,labels=c('A'=parse(text=TeX('No covariate')),
                                               'B'=parse(text=TeX('Including $T^{GWAS}$'))))

ggplot(df3, aes(x = LONG, y = LAT, fill = value)) + geom_tile() + facet_wrap(~variable, labeller=label_parsed) + theme_classic() +  theme(panel.border = element_rect(colour = "black", fill=NA, size=1), axis.title = element_text(size = 20), axis.text = element_text(size = 12), legend.title = element_text(size = 16), strip.text.x = element_text(size = 16)) + scale_fill_gradient2(low = "red", high = "blue", mid = "white", limits = c(-0.5, 0.5), name = "PGS") + xlab("Longitude") + ylab("Latitude") + scale_y_continuous(breaks=seq(0,6,1)) + scale_x_continuous(breaks=seq(0,6,1)) 
```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
df <- fread("../code/plot/4PopSplit_F100_rescale.txt")
nc <- df %>% filter(type == "nc") %>% group_by(env, type, case) %>% summarise(fp_strat = sum(`P-EN` < 0.05)/ n(), avg_Ax = mean(Ax)) %>% separate(env, c("env", "diff"), "-")
nc$diff <- as.numeric(nc$diff)

nc <- subset(nc, nc$diff < 0.07)
ggplot(data = nc, aes(x = diff, y = fp_strat, color = case)) + geom_point(size =3)+ xlab("Mean(A) - Mean(C)") + ylab("False Postive Rate") + theme_classic(base_size = 14) + scale_color_manual(values = c("darkorchid4", "dodgerblue"), labels = unname(TeX(c("Biased", "Unbiased")))) + theme(panel.border = element_rect(colour = "black", fill=NA, size=1)) + ylim(0,1) + labs(colour="") + theme(legend.text.align = 0)+ geom_hline(yintercept = 0.05, color = "red") +  geom_smooth(method = "loess", se = FALSE) 
```

